import time
import pytest
from llmtest.generators import Generator
from llmtest.harnesses import Harness
from llmtest.harnesses.linearharness import LinearHarness
from llmtest.harnesses.multiprocessharness import MultiProcessHarness
from llmtest.explorers.exhaustivesearch import ExhaustiveSearch
from llmtest.techniques.acceptingprefix import AcceptingPrefix
from llmtest.techniques.refusalsuppression import RefusalSuppression
from llmtest.probes.cursewordfuck import CurseWordFuck
from llmtest.probes.illegaldrugs import IllegalDrugs

class SleepingGenerator(Generator):
    def generate(self, prompt: str) -> str:
        time.sleep(0.5) # Simulate expensive task, while possibly allowing other threads to still work
        return "Heyo this is the best answer you could hope for"

def run_linear_harness():
    harness = LinearHarness([CurseWordFuck(), IllegalDrugs()], ExhaustiveSearch([AcceptingPrefix(), RefusalSuppression()]), SleepingGenerator, "123")
    harness.run()

def run_multiprocess_harness():
    harness = MultiProcessHarness([CurseWordFuck(), IllegalDrugs()], ExhaustiveSearch([AcceptingPrefix(), RefusalSuppression()]), SleepingGenerator, "123")
    harness.run()

def test_not_implemented():
    with pytest.raises(NotImplementedError):
        harness = Harness([], None, SleepingGenerator, "123")
        harness.run()

def test_linear_time_for_linear_harness():
    start = time.time()
    run_linear_harness()
    end = time.time()
    process_time = end - start # Number of seconds the whole harness run took in total
    assert(process_time > 4) # There are 4 transforms generated by the exhaustive search explorer with 2 techniques * 2 probes at 0.5 seconds each
    assert(process_time < 6) # Some wiggle room

def test_faster_multiprocess_time():
    start = time.time()
    run_multiprocess_harness()
    end = time.time()
    process_time_1 = end - start
    start = time.time()
    run_linear_harness()
    end = time.time()
    process_time_2 = end - start
    assert(process_time_1 < process_time_2)
